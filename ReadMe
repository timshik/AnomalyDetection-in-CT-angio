we took healthy scans, mask them with rate (0<rate<1) and then tried to reconstruct them

for rate = 0.2 the reconstruction is almost perfect
when the trained model were given with healthy scans without mask, he again reconstructed them almost perfectly (left the scan as it is, see in 'test' folder)

further thoughts

there are few approaches we can take now

1) we can give the model scans with distal clot and hope that he will see the clot as mask, therefore he will reconstruct the scan without the clot
then we can take the difference between the original and the created and find the clot.

2) we can give the model the scans with distal clot, only this time we will mask it,
hopefully the model won't reconstruct the clot (its an anomaly that he not suppose to be aware of).
here we can play with the rate variable, the bigger it is the more blank pixels will appear in the scan,
and so the model will have more pixels to reconstruct which might harden the task to reconstruct the clot ( we dont want the model to succeed reconstruct the clot)

3) we can try to apply some simpler anomaly detection algorithm on the latent variable (the result of the encoder ) that we got
hoping that the model encoded enough information on the scan in that variable to differentiate normal scans from anomaly scans (distal clot)
again here we can play with the mask rate, the bigger it is the model will have to understand the architecture of the scan better,
and hopefully create better representation for the scans.


### we can use other scans (or maybe combining ) for that task ( like parenchyma ) so the clot will be bold, and it will be hard for the model to reconstruct the right color
### for now we are working with downscaled version of the scans, because its time consuming working with the 1024X1024 version.


ניסתי עם MASK = 0.5
המודל ידע להשלים בצורה טובה מדי את החסר ולכן לא השלים את הענפים החסומים
עבור 0.8 המודל עדיין הצליח להשלים מספיק טוב את החלקים החסרים, עם קצת רעש. עדיין זה לא היה מספיק בשביל להשלים את הענפים החסומים.
עבור 0.95 המודל ייצר פשוט רעש
אפשר לנסות לקחת ערך בין 0.95 ל 0.8 אבל כניראה שכל עוד המודל יצליח לשחזר הוא ידע לא לשחזר את הכלים החסומים.
כניראה שמה שהוא לומד לעשות זה מעין ממוצע של הפיקסלים מסביב לפיקסלים החסרים ולכן כל עוד יש לו מספיק מידע מסביב לפיקסל החסר הוא ישלים אותו בצורה טובה מדי (לא ינסה להשלים את הענף החסום)
לכן אולי כדאי להתחיל להסתיר סביבה שלמה וכך המודל יצטרך ללמוד יותר מאשר לעשות ממוצע פיקסלים מסביב לנקודה
ניתן לשחק עם גודל הסביבה שאנחנו מחסירים ועם כמות הסביבות שאנחנו מחסירים. ניתן גם לעשות את ההשלמה עם היסטוגרמות כמו 8200

1) 0.5, 2) 0.78 3) 0.85 4) 0.95
כשניסיתי לשים קוביות יותר גדולות(50X50)

על ה TEST ולהשתמש בשחזור שנלמד על הפיקסלים הבודדים אפשר לראותש המודל לא מצליח לשחזר ומשאיר את הריבועים הלבנים בעינם (פרט לקצת גוון אפרפר) כלומר אכן אפשר לראות שהמודל פשוט למד לעשות ממוצע על הפיקסל החסרת לכן הפיקסלים שנמצאים באמצע נשארו כמעט לבנים (הם מיצוע של פיקסלים לבנים ) והפיקסלים בפינות קיבלו גוון אפרפר מהפיקסלים מחוץ לריבוע
בסריקות שלנו ההבדל בעוצמה בין פיקסלים דומים הוא נמוך יחסית ולכן כניראה השיטה הזאת לא עובדת

עד לכאן הניסוי הראשון צריך למספר אותו לפי  (?).1
2.1
ניסיתי לעשות ריבועים בגודל 50X50 בהסתברות 0.0001 ניתן לראות שהמודל משחזר בצורה טובה עורקים שהוא רואה את ההתחלה ואת הסוף שלהם, אך לא מצליח לשחזר ורידים שהוא רואה רק את ההתחלה שלהם, בנוסף הוא מצליח לשחזר עורקים שהקונטרסט שלהם חזק (כלומר הם יותר שחורים כנגד הרקע הלבן ) לעומת זאת הוא לא מצליח טוב כאשר העורק צבוע חלש (עורקים דיסטאליים ), גם בישחזורים הטובים המודל עושה את זה די מרוח, כלומר הוא עושה מיצוע כל שהוא על הצבעים, והוא יודע להשלים רק את הרקע בצורה מושלמת 

אפשר לראות את התוצאות בתיקייה 2.1

מכאן יש לנו כמה אפשרויות להתקדם 
1) להקטין את הריבועים: אולי הריבועים גדולים מדי ולכן אין לו מספיק קונטקסט כדי למלא אותם 
2) להקטין את מספר הריבועים: יכול להיות שיותר מדי חלקים מהתמונה מוסתרים ולכן הוא לא מצליח לשחזר מספיק טוב 
3) להחליף את הצבעים בתמונה: כלומר img-i255 בצורה כזאת ערכי הפיקסלים שמייצגים את התמונה יהיו יותר גבוהים ולא שואפים ל 0 כמו עכשיו 
4) טרנספורמציה של כל הצבעים למספר צבעים קטן וקבוע: אין לנו צורך בכל סרגל הצבעים מ 0-255 המידע בתמונה הוא בינארי (יש עורק\ אין עורק) מכיוון שמאוד קשה למצוא את הסף שיפריד בין הרקע לעורקים הדיסטאליים, אפשר להפוך את התמונה לכמה צבעים, בנוסף אפשר לנסות לנרמל את התמונה כדי שהערכים יהיו בין חצי למינוס חצי 
5) אני פחות בטוח בכיוון הזה, אולי לנסות להפוך את המאסקים לפחות בולטים, כלומר שיהיה להם צבע של הרקע, בצורה כזאת המודל יצטרך לדעת עבור כל נקודה ברקע האם אמור לעבור שם עורק או לא אמור לעבור שם עורק, ולא רק בקוביות הלבנות. בנוסף זה יכול לעזור למודל עם הרעש של הריבוע הלבן. אם המודל יצליח ללמוד בצורה טובה איך להשלים מסיכות כאלה אולי הוא יוכל להשלים חסימות בתמונה של מטופל חולה ללא מסיכות.
6) לנסות לחזות היסטוגרמות במקום לנסות לשחזר את התמונה

נניח שהמודל הצליח להשלים בצורה טובה את ה קוביות, איך ניתן ציון לתחזית ? 
אפשר להעביר את הקוביה על כל התמונה ולחפש את הקוביה שבה הוא יש שוני גדול בין מה שהוא חזה למקור.

2.2
הורדתי את הקוביה ל 25X25 אפשר לראות שהשחזור משמעותית יותר טוב כעת, כדי להעריך האם המודל יודע לשחזר כרישים צריך לרשום את הסקריפט שמריץ קוביה על כל הסריקה ובכל נקודה בודק האם המודל שחזר את הקוביה בצורה טובה.

MASK RATE = 0.0002

לעשות גרף שמציג את כל התוצאות שקיבלתי עבור כל נבדק בגרף הזה אפשר לראות האם ניתן להפריד את ה חולים והבריאים בעזרת סף או לא

עד עכשיו הרצתי ל 750 אפוקים
2.3
שוב 50*50
ל 2500 אפוקים



אם מסתכלים על המקומות החסומים אפשר לראות שהמודל מצליח לזהות אותם פשוט הוא מסמן גם אזורים אחרים בביטחון גבוהה יותר, אחת הבעיות היא שככל שהתמונה יותר שחורה כך יש יותר סיכוי שהמודל יסמן את המקום הזה, מכיוון שהמודל משחזר באופן מעורפל ולכן כשהוא מורח את הצבע השחור הוא מקבל הפרש גבוהה מהמקור אולי אם נעשה EQUALIZE לצבעים זה יקטין את ההפרש הזה
2.4
נסיון אחרון מהסריה הזאת
75*75
0.00003
1500 אפוקים

עד עכשיו ההרגשה היא שהמודל יודע לשחזר את העורק רק אם הוא ראה עורק שנכנס לקוביה ועורק שיוצא, לעומת זאת אם הוא רואה עורק רק בכיוון אחד הוא לא יודע להשלים אותו. דבר שהגיוני מכיוון שאם הקוביה קטנה יחסית והעורק נכנס אבל לא יוצא כניראה שהוא נגמר שם, לכן הגדלת הקוביה יכולה לגרום לכך שיהיה למודל יותר שטח מת שטח שאליו יכול להיות שנכנס עורק ולא יוצא אבל בתוכו יש עדיין עורק כלומר הוא יצטרך ללמוד איך העורק נראה גם אם הוא מגיע רק מכיוון אחד.
3.1
ניסיתי להפוך את התמונה לבינארית מסף מסויים אבל לא קיים סף שבו מצד אחד כל העורקים צבועים ומצד שני כל הרקע לבן (אפשר להראות דוגמאות )
QUANTIZE
1500
50*50
0.0001
להראות כמה דוגמאות של הורדת הצבעים ל 6 8 ו 10 ולהסביר ש 7 הוא המספר הכי טוב מכיוון שהעורקים הבולטים נשארים באותו הצבע

אפשר לנסות לעשות את ה קוונטייז גם בטריין וגם בטסט או שאפשר לנסות ללמוד על תמונות רגילות אבל בטסט להמיר אותן לפחות צבעים

ניסיתי למצוא את הכרישים על התמונות הקוונטייזד

4.1
לאחר שהקוונטייז לא עבד בצורה טובה מספיק ( אולי עוד אפשר לנסות למדל את הצבעים בצורה יותר טובה )
אנסה לנרמל את הSCORES כלומר לחלק בממוצע הצבע של אותה המשבצת, כך משבצות שחורות יקבלו מראש תוצאה יותר נמוכה

אם נרמול 200 הנקודות השחורות מאבדות מהתוצאות שלהם באמת אך הדגש עובר לנקודות בעלות בהירות נמוכה מדי (כלומר הבעיה ההפוכה ) נרמול 255 לא עזר כמעט

הרכבה של קוונטייז עם נירמול נותנת תוצאות לא רעות, הבעיה היא שהוא מזהה קיפול של העורק הרבה פעמים (הדרך להתגבר זה להסתכל ממנך נוסף )



##########################
אימון נוסף של רשתות

ניסתי 3 רשתות שונות
UNET
DEEP PRIOR  MASK SIZE 0.5 MASK RATE 0.0001
VAE
את ההיפר פרמטרים של כל אחד בדקתי על הדאטא עם דגימה רנדומלית של הדאטאסט
ולאחר מכן שלושתם נבדקו על TEST SET שונה

ברור שאי אפשר לקבוע שאם רשת אחת עובדת יותר טוב על משימה ספציפית היא גם תעבוד יותר טוב על שאר המשימות, אבל בגלל הדמיון בין המשימות ובגלל שאין לי את הכוח החישובי להריץ השוואה בין הרשתות בכל שלב בניסוי, (בנוסף זה גם יכול לגרום ל אוברפיט) עשיתי את ההשוואה פעם אחת וארוץ עם הבחירה שתתקבל
אשווה את המודלים בעזרת L1 ו L2